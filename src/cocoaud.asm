	NAM	CoCoAud
	TTL	Audio player for CoCo

LOAD	EQU	$0E00		Actual load address for binary

IRQADR	EQU	$5F66
SAMR1ST	EQU	$FFD9

TIMEVAL	EQU	648

	ORG	LOAD

* Disable IRQ and FIRQ
EXEC	ORCC	#$50
* Disable PIA IRQ generation
	LDX	#$FF00
	LDA	1,X
	ANDA	#$3E
	STA	1,X
	LDA	,X
	LDA	3,X
	ANDA	#$3E
	STA	3,X
	LDA	2,X

* High-speed poke...definitely...
	STA	SAMR1ST

* Select DAC sound output
	LDA	$FF01
	ANDA	#$C7
	ORA	#$30
	STA	$FF01
	LDA	$FF03
	ANDA	#$C7
	ORA	#$30
	STA	$FF03
* Enable sound output
	LDA	$FF23
	ANDA	#$C7
	ORA	#$38
	STA	$FF23
* Init timer interrupt generation
	LDD	#TIMEVAL
	STD	$FF94
	LDA	$FF91
	ORA	#$20
	STA	$FF91
	LDA	$FF92
	ORA	#$20
	STA	$FF92
	LDA	$FF90
	ORA	#$20
	STA	$FF90
* Enable IRQ handling
	LDD	#SNDISR
	STD	IRQADR
	ANDCC	#$EF

* Init sample storage
	CLRA
	CLRB
	STD	>SAMPLE

INLOOP	JSR	[$A000]
	BEQ	INLOOP
	CMPA	#$03
	BEQ	EXIT
	BRA	INLOOP

EXIT	JMP	[$FFFE]

* Read samples and stuff them into the DAC
SNDISR	LDD	>SAMPLE
	CMPA	#$00
	BEQ	SNDISR1
	CLRA
	ANDB	#$7C
	STB	$FF20
	BRA	SNDISR4
SNDISR1	LDX	#$FFE0
	LDA	1,X
	BEQ	SNDISR5
	LDA	,X
*
*	PSHS	A
*
* Convert 2x4-bit to 2x8-bit
	BMI	SNDISR2
	LDY	#CLWLOTB
	BRA	SNDISR3
SNDISR2	EQU	*
	LDY	#CLWHITB
	ANDA	$#7F
SNDISR3	EQU	*
	LDD	A,Y
* End 2x4-bit to 2x8-bit conversion
*
*	PULS	A
*
	ANDA	#$7C
	STA	$FF20
	LDA	#$FF	
*
*	CLRA
*
* Clear timer interrupt
SNDISR4	STD	>SAMPLE
SNDISR5	LDB	$FF92
	RTI

CLWLOTB	FDB	$0404,$0418,$042C,$0440,$0454,$0460,$046C,$0478,
	FDB	$0484,$0490,$049C,$04A8,$04BC,$04D0,$04E4,$04F8,
	FDB	$1804,$1818,$182C,$1840,$1854,$1860,$186C,$1878,
	FDB	$1884,$1890,$189C,$18A8,$18BC,$18D0,$18E4,$18F8,
	FDB	$2C04,$2C18,$2C2C,$2C40,$2C54,$2C60,$2C6C,$2C78,
	FDB	$2C84,$2C90,$2C9C,$2CA8,$2CBC,$2CD0,$2CE4,$2CF8,
	FDB	$4004,$4018,$402C,$4040,$4054,$4060,$406C,$4078,
	FDB	$4084,$4090,$409C,$40A8,$40BC,$40D0,$40E4,$40F8,
	FDB	$5404,$5418,$542C,$5440,$5454,$5460,$546C,$5478,
	FDB	$5484,$5490,$549C,$54A8,$54BC,$54D0,$54E4,$54F8,
	FDB	$6004,$6018,$602C,$6040,$6054,$6060,$606C,$6078,
	FDB	$6084,$6090,$609C,$60A8,$60BC,$60D0,$60E4,$60F8,
	FDB	$6C04,$6C18,$6C2C,$6C40,$6C54,$6C60,$6C6C,$6C78,
	FDB	$6C84,$6C90,$6C9C,$6CA8,$6CBC,$6CD0,$6CE4,$6CF8,
	FDB	$7804,$7818,$782C,$7840,$7854,$7860,$786C,$7878,
	FDB	$7884,$7890,$789C,$78A8,$78BC,$78D0,$78E4,$78F8,

CLWHITB	FDB	$8404,$8418,$842C,$8440,$8454,$8460,$846C,$8478,
	FDB	$8484,$8490,$849C,$84A8,$84BC,$84D0,$84E4,$84F8,
	FDB	$9004,$9018,$902C,$9040,$9054,$9060,$906C,$9078,
	FDB	$9084,$9090,$909C,$90A8,$90BC,$90D0,$90E4,$90F8,
	FDB	$9C04,$9C18,$9C2C,$9C40,$9C54,$9C60,$9C6C,$9C78,
	FDB	$9C84,$9C90,$9C9C,$9CA8,$9CBC,$9CD0,$9CE4,$9CF8,
	FDB	$A804,$A818,$A82C,$A840,$A854,$A860,$A86C,$A878,
	FDB	$A884,$A890,$A89C,$A8A8,$A8BC,$A8D0,$A8E4,$A8F8,
	FDB	$BC04,$BC18,$BC2C,$BC40,$BC54,$BC60,$BC6C,$BC78,
	FDB	$BC84,$BC90,$BC9C,$BCA8,$BCBC,$BCD0,$BCE4,$BCF8,
	FDB	$D004,$D018,$D02C,$D040,$D054,$D060,$D06C,$D078,
	FDB	$D084,$D090,$D09C,$D0A8,$D0BC,$D0D0,$D0E4,$D0F8,
	FDB	$E404,$E418,$E42C,$E440,$E454,$E460,$E46C,$E478,
	FDB	$E484,$E490,$E49C,$E4A8,$E4BC,$E4D0,$E4E4,$E4F8,
	FDB	$F804,$F818,$F82C,$F840,$F854,$F860,$F86C,$F878,
	FDB	$F884,$F890,$F89C,$F8A8,$F8BC,$F8D0,$F8E4,$F8F8,

SAMPLE	RMB	2

	END	EXEC
