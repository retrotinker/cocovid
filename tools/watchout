#!/bin/sh

RAW2PPM=$(dirname $0)/raw2ppm

cleanup()
{
	kill -HUP $PID >/dev/null 2>&1
	kill -HUP $OLDPID >/dev/null 2>&1
	exit 0
}

trap cleanup 1 2 3 15

FEH_ARGS='-Z -F'

while [ ! -d ../raw/$1 ]
do
	sleep 1
done

cd ../raw/$1

while [ ! -f current.raw ]
do
	sleep 1
done

LASTMOD=$(stat -c '%Y' current.raw)
$RAW2PPM current.raw current.ppm >/dev/null 2>&1
convert -resize 90x100%! current.ppm view.ppm
feh $FEH_ARGS view.ppm >/dev/null 2>&1 &
OLDPID=$!

while true
do
	if [ ! -d /proc/$OLDPID ]
	then
		break
	fi
	if [ -f current.raw ]
	then
		CURMOD=$(stat -c '%Y' current.raw)
	else
		break
	fi
	if [ $? != 0 ]
	then
		break
	fi
	if [ $LASTMOD -lt $CURMOD ]
	then
		LASTMOD=$CURMOD
		$RAW2PPM current.raw current.ppm >/dev/null 2>&1
		convert -resize 90x100%! current.ppm view.ppm
		feh $FEH_ARGS view.ppm >/dev/null 2>&1 &
		PID=$!
		sleep 1
		kill -HUP $OLDPID >/dev/null 2>&1
		OLDPID=$PID
	fi
done

cleanup
